// src/test_circular.cpp
#include <iostream>
#include <string>

#include "shared_ptr.hpp"

class Woman;

class Man {
public:
  Man() { std::cout << "  Man Created" << std::endl; }
  ~Man() { std::cout << "  Man Destroyed" << std::endl; }

  SharedPtr<Woman> girlfriend;
};

class Woman {
public:
  Woman() { std::cout << "  Woman Created" << std::endl; }
  ~Woman() { std::cout << "  Woman Destroyed" << std::endl; }

  SharedPtr<Man> boyfriend;
};

int main() {
  std::cout << "--- Test 4: Circular Dependency (The Trap) ---" << std::endl;

  {
    // 1. åˆ›å»º m å’Œ w
    SharedPtr<Man> m(new Man());
    SharedPtr<Woman> w(new Woman());

    std::cout << "Initially - m UseCount: " << m.UseCount() << std::endl;
    std::cout << "Initially - w UseCount: " << w.UseCount() << std::endl;

    // 2. å»ºç«‹å¾ªç¯å¼•ç”¨ (äº’ç›¸æŒ‡å‘)
    /*
    è¯¦è§£ï¼šm->girlfriend = w
    m (æ ˆä¸Šçš„ SharedPtr<Man>) é‡Œé¢æœ‰ä¸€ä¸ªæŒ‡é’ˆ ptr_ã€‚
    è¿™ä¸ª ptr_ æŒ‡å‘å †ä¸Šçš„ä¸€å—å¤§å†…å­˜ â€”â€” Man å¯¹è±¡ã€‚å…³é”®ç‚¹ï¼šgirlfriend ä¸æ˜¯é£˜åœ¨ç©ºä¸­çš„ï¼Œå®ƒæ˜¯ Man å¯¹è±¡ä½“å†…çš„ä¸€éƒ¨åˆ†ã€‚
    å¯ä»¥æŠŠ Man å¯¹è±¡æƒ³è±¡æˆä¸€ä¸ªæˆ¿å­ï¼Œgirlfriend æ˜¯æˆ¿å­é‡Œçš„ä¸€ä¸ªä¿é™©ç®±ã€‚
      [ æ ˆ (Stack) ]                       [ å † (Heap) ]
      +-----------+                +----------------------------+
      |     m     | ---ptr_------> |        Man Object          |
      +-----------+                | +------------------------+ |
                                   | | girlfriend (SharedPtr) | | | <--- è¿™é‡Œçš„ SharedPtr
                                   | +------------------------+ |
                                   +----------------------------+

    ptr_ ä¸éœ€è¦æŒ‡å‘ girlfriendï¼Œå®ƒæŒ‡å‘çš„æ˜¯ Manï¼ˆæˆ¿å­ï¼‰ã€‚

    å½“ç¼–è¯‘å™¨çœ‹åˆ° m->girlfriend æ—¶ï¼Œå®ƒæ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š
    1. m->ï¼šè°ƒç”¨ SharedPtr çš„é‡è½½è¿ç®—ç¬¦ operator->ï¼Œè¿”å›å†…éƒ¨å­˜çš„ Man* æŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯é‚£æŠŠå¼€æˆ¿é—¨çš„é’¥åŒ™ï¼‰ã€‚
    2. è®¿é—®æˆå‘˜ï¼šé€šè¿‡è¿™ä¸ª Man* æŒ‡é’ˆï¼Œæ‰¾åˆ°å†…å­˜åç§»é‡ï¼Œå®šä½åˆ° Man å¯¹è±¡å†…éƒ¨çš„ girlfriend æˆå‘˜å˜é‡ã€‚
    3. æ‰€ä»¥ï¼Œm->girlfriend è¿™åŠå¥è¯ï¼Œæœ€ç»ˆæ‹¿åˆ°çš„å°±æ˜¯ å †ä¸Šé‚£ä¸ª Man å¯¹è±¡è‚šå­é‡Œçš„ girlfriend æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡ã€‚

    m->girlfriend = w;
    è¿™ä¸€å¥è§¦å‘äº† æ‹·è´èµ‹å€¼å‡½æ•° (Copy Assignment)ï¼šSharedPtr& operator=(const SharedPtr& other)ã€‚
    1. å·¦è¾¹ (girlfriend) è¯´ï¼šâ€œæˆ‘è¦æ‹·è´ä½  (w)ã€‚â€
    2. åŠ¨ä½œï¼šgirlfriend æŠŠ w çš„ ptr_ å’Œ ref_count_ å¤åˆ¶äº†è¿‡æ¥ã€‚
    3. æ ¸å¿ƒï¼šå› ä¸ºæ˜¯æ‹·è´ï¼Œæ‰€ä»¥å¼•ç”¨è®¡æ•°å™¨ +1ã€‚
    */
    std::cout << "Linking them together..." << std::endl;
    m->girlfriend = w;
    w->boyfriend = m;

    std::cout << "Linked - m UseCount: " << m.UseCount() << std::endl;
    std::cout << "Linked - w UseCount: " << w.UseCount() << std::endl;

    std::cout << "Exiting scope..." << std::endl;
  } 
  // 3. ç¦»å¼€ä½œç”¨åŸŸ
  // é¢„æœŸï¼šè¿™é‡Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ (æ²¡æœ‰ Destroyed æ—¥å¿—)ï¼Œå› ä¸ºå†…å­˜æ³„æ¼äº†ï¼
  /*
  ä¸ºä»€ä¹ˆå†…å­˜æ³„æ¼ï¼š
  ===============================================================================================
  ğŸ•µï¸â€â™€ï¸æ¡ˆå‘ç°åœºï¼š
  Main å‡½æ•°ç»“æŸå‰ï¼Œæ­¤æ—¶å¤§å®¶éƒ½è¿˜æ´»ç€ï¼Œäº’ç›¸æ‰‹æ‹‰æ‰‹ï¼š
  æ ˆä¸Šçš„ m æŒ‡ç€ -> å †ä¸Šçš„ Manã€‚å †ä¸Šçš„ Woman (boyfriend) æŒ‡ç€ -> å †ä¸Šçš„ Manã€‚Man çš„è®¡æ•° = 2
  æ ˆä¸Šçš„ w æŒ‡ç€ -> å †ä¸Šçš„ Womanã€‚å †ä¸Šçš„ Man (girlfriend) æŒ‡ç€ -> å †ä¸Šçš„ Womanã€‚Woman çš„è®¡æ•° = 2

  ===============================================================================================
  ğŸ’¥æ¯ç­è¿‡ç¨‹ (Main å‡½æ•°ç»“æŸ)
  ææ„é¡ºåºé€šå¸¸æ˜¯ç›¸åçš„ï¼ˆåè¿›å…ˆå‡ºï¼‰ï¼Œæˆ‘ä»¬å‡è®¾ w å…ˆæ­»ï¼Œç„¶å m æ­»ï¼ˆåè¿‡æ¥ç»“æœä¹Ÿä¸€æ ·ï¼‰ã€‚
  ç¬¬ä¸€æ­¥ï¼šæ ˆä¸Šçš„ w é”€æ¯
    åŠ¨ä½œï¼šw (æ ˆå˜é‡) ç¦»å¼€äº†ä½œç”¨åŸŸï¼Œææ„ã€‚
    å½±å“ï¼šå®ƒå¯¹å †ä¸Šçš„ Woman çš„å¼•ç”¨æ¾å¼€äº†ã€‚
    è®¡æ•°å˜åŒ–ï¼šWoman çš„è®¡æ•°ä» 2 å‡ä¸º 1ã€‚
    æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ 1 ä¸æ˜¯ 0ï¼Ÿ
      å› ä¸ºå †ä¸Šçš„ Man è¿˜æ²¡æ­»ï¼Man è‚šå­é‡Œçš„ girlfriend æŒ‡é’ˆè¿˜æŒ‡å‘å †ä¸Šçš„ Womanã€‚
    åæœï¼šWoman å¯¹è±¡ä¸ææ„ï¼Œä¾ç„¶æ´»åœ¨å †ä¸Šã€‚

  ç¬¬äºŒæ­¥ï¼šæ ˆä¸Šçš„ m é”€æ¯
    åŠ¨ä½œï¼šm (æ ˆå˜é‡) ç¦»å¼€äº†ä½œç”¨åŸŸï¼Œææ„ã€‚
    å½±å“ï¼šå®ƒå¯¹ å †ä¸Šçš„ Man çš„å¼•ç”¨æ¾å¼€äº†ã€‚
    è®¡æ•°å˜åŒ–ï¼šMan çš„è®¡æ•°ä» 2 å‡ä¸º 1ã€‚
    æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ˜¯ 1 ä¸æ˜¯ 0ï¼Ÿ
      å› ä¸ºå †ä¸Šçš„ Woman åˆšæ‰æ²¡æ­»ï¼ˆçœ‹ç¬¬ä¸€æ­¥ï¼‰ï¼Woman è‚šå­é‡Œçš„ boyfriend æŒ‡é’ˆä¾ç„¶ç´§ç´§æŠ“ç€ å †ä¸Šçš„ Manã€‚
    åæœï¼šMan å¯¹è±¡ä¸ææ„ï¼Œä¾ç„¶æ´»åœ¨å †ä¸Šã€‚


  ===============================================================================================
  â˜ ï¸ æœ€ç»ˆåƒµå±€
  å½“ main å‡½æ•°å½»åº•ç»“æŸåï¼Œä¸–ç•Œå®‰é™äº†ï¼Œæ ˆç©ºäº†ã€‚ä½†åœ¨å †å†…å­˜çš„æ·±å¤„ï¼Œæœ‰ä¸¤ä¸ªâ€œå¹½çµâ€äº’ç›¸æŠ“ç€å¯¹æ–¹ä¸æ”¾ï¼š
  1. å †ä¸Šçš„ Manï¼šè¿˜æ´»ç€ï¼ˆå› ä¸º Woman æŠ“ç€ä»–ï¼‰ã€‚
     å› ä¸º Man æ´»ç€ï¼Œæ‰€ä»¥ä»–è‚šå­é‡Œçš„ girlfriend æŒ‡é’ˆå°±å­˜åœ¨ã€‚
     æ‰€ä»¥ girlfriend ç»§ç»­æŠ“ç€ Womanã€‚
  2. å †ä¸Šçš„ Womanï¼šè¿˜æ´»ç€ï¼ˆå› ä¸º Man æŠ“ç€å¥¹ï¼‰ã€‚
     å› ä¸º Woman æ´»ç€ï¼Œæ‰€ä»¥å¥¹è‚šå­é‡Œçš„ boyfriend æŒ‡é’ˆå°±å­˜åœ¨ã€‚
     æ‰€ä»¥ boyfriend ç»§ç»­æŠ“ç€ Manã€‚
  */

  std::cout << "--- End of Test ---" << std::endl;
  return 0;
}

