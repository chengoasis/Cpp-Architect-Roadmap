# Week 05: Modern C++ High-Performance Networking

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäº **Reactor æ¨¡å¼é›å½¢** çš„å¤šçº¿ç¨‹ TCP æœåŠ¡å™¨ã€‚å®ƒæ‘’å¼ƒäº†ä¼ ç»Ÿ C è¯­è¨€ç½‘ç»œç¼–ç¨‹ä¸­ç¹ççš„é”™è¯¯æ£€æŸ¥å’Œèµ„æºç®¡ç†ï¼Œåˆ©ç”¨ **RAII (èµ„æºè·å–å³åˆå§‹åŒ–)**ã€**æ™ºèƒ½æŒ‡é’ˆ** å’Œ **ç§»åŠ¨è¯­ä¹‰**ï¼Œæ„å»ºäº†ä¸€ä¸ªå®‰å…¨ã€é«˜æ•ˆä¸”ä¼˜é›…çš„ç½‘ç»œå±‚åŸºç¡€è®¾æ–½ã€‚



## ğŸ§  æ ¸å¿ƒçŸ¥è¯†ç‚¹ 

### 1. ä»€ä¹ˆæ˜¯ Socket (å¥—æ¥å­—)ï¼Ÿ

åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼ŒSocket æ˜¯ç½‘ç»œé€šä¿¡çš„ç«¯ç‚¹ã€‚

- **æ–‡ä»¶æè¿°ç¬¦ (File Descriptor, fd)**ï¼šåœ¨ Linux ä¸­â€œä¸€åˆ‡çš†æ–‡ä»¶â€ã€‚Socket è¢«åˆ›å»ºåï¼Œç³»ç»Ÿä¼šè¿”å›ä¸€ä¸ª `int` ç±»å‹çš„æ•°å­—ï¼ˆå¦‚ 3, 4, 5...ï¼‰ï¼Œè¿™å°±æ˜¯ `fd`ã€‚åç»­æ‰€æœ‰çš„è¯»å–ã€å†™å…¥ã€å…³é—­æ“ä½œï¼Œéƒ½æ˜¯å¯¹ç€è¿™ä¸ªæ•°å­—è¿›è¡Œçš„ã€‚
- **é€šä¿¡æµç¨‹ç±»æ¯”**ï¼š
  1. `socket()`: ä¹°ä¸ªæ‰‹æœºã€‚
  2. `bind()`: æ’å…¥ SIM å¡ï¼ˆç»‘å®šæœ¬æœº IP å’Œç«¯å£ï¼‰ã€‚
  3. `listen()`: å¼€æœºï¼Œè®¾ç½®é“ƒå£°ï¼ˆå¼€å§‹ç›‘å¬ï¼‰ã€‚
  4. `accept()`: ç”µè¯å“äº†ï¼Œæ¥é€šï¼ˆé˜»å¡ç­‰å¾…ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ fd ä¸“é—¨ç”¨äºé€šè¯ï¼‰ã€‚

### 2. RAII ä¸ èµ„æºç®¡ç†

**ç—›ç‚¹**ï¼šåœ¨ C è¯­è¨€ä¸­ï¼Œå¿…é¡»æ—¶åˆ»è®°å¾—åœ¨ `return` å‰è°ƒç”¨ `close(fd)`ã€‚ä¸€æ—¦é—å¿˜æˆ–ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œfd å°±ä¼šæ³„éœ²ï¼Œæœ€ç»ˆå¯¼è‡´æœåŠ¡å™¨è€—å°½èµ„æºå´©æºƒã€‚

**Modern C++ æ–¹æ¡ˆ**ï¼š

- å°† `fd` åŒ…è£…åœ¨ `Socket` ç±»ä¸­ã€‚
- **æ„é€ å‡½æ•°**ï¼šè°ƒç”¨ `socket()` è·å–èµ„æºã€‚
- **ææ„å‡½æ•°**ï¼šè‡ªåŠ¨è°ƒç”¨ `close()` é‡Šæ”¾èµ„æºã€‚
- **æ•ˆæœï¼šæ— è®ºç¨‹åºæ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œåªè¦ `Socket` å¯¹è±¡ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿æ¥å°±ä¼šè‡ªåŠ¨å…³é—­ã€‚**

### 3. ç½‘ç»œå­—èŠ‚åº (Big-Endian)

- **ä¸»æœºå­—èŠ‚åº (Little-Endian)**ï¼šIntel/AMD CPU å­˜å‚¨æ•°æ®æ—¶ï¼Œä½ä½åœ¨å‰ï¼ˆå¦‚ `0x1234` å­˜ä¸º `34 12`ï¼‰ã€‚
- **ç½‘ç»œå­—èŠ‚åº (Big-Endian)**ï¼šTCP/IP åè®®è§„å®šï¼Œç½‘ç»œä¼ è¾“å¿…é¡»é«˜ä½åœ¨å‰ï¼ˆ`12 34`ï¼‰ã€‚
- **è½¬æ¢å‡½æ•°**ï¼š
  - `htons` (Host to Network Short): ç”¨äºç«¯å£è½¬æ¢ (16ä½)ã€‚
  - `htonl` (Host to Network Long): ç”¨äº IP åœ°å€è½¬æ¢ (32ä½)ã€‚

### 4. ç§»åŠ¨è¯­ä¹‰ (Move Semantics) ä¸æ‰€æœ‰æƒ

- `Socket` å¯¹è±¡ä»£è¡¨ä¸€ä¸ªç‹¬å çš„ç³»ç»Ÿèµ„æºã€‚
- **ç¦æ­¢æ‹·è´** (`delete copy ctor`)ï¼šä¸èƒ½è®©ä¸¤ä¸ªå¯¹è±¡ç®¡ç†åŒä¸€ä¸ª fdï¼Œå¦åˆ™ææ„æ—¶ä¼šå‘ç”Ÿ Double Free (é‡å¤å…³é—­)ã€‚
- **å…è®¸ç§»åŠ¨** (`move ctor`)ï¼šä½¿ç”¨ `std::move` å°† fd çš„æ‰€æœ‰æƒä»ä¸€ä¸ªå¯¹è±¡â€œè½¬ç§»â€åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼ŒåŸå¯¹è±¡è¢«ç½®ç©ºï¼ˆ`fd = -1`ï¼‰ã€‚

------

## ğŸ—ï¸ æ¶æ„è®¾è®¡ (Architecture)

### æµç¨‹å›¾è§£

```tex
[Client]      [Main Thread]                [ThreadPool (Worker Threads)]
   |                |                                   |
   | Connect        |                                   |
   +------------->  | accept()                          |
                    | -> äº§ç”Ÿ Socket(fd=4)               | 
                    | -> åŒ…è£…æˆ shared_ptr<Socket>       |
                    |                                   |
                    | pool.Submit(task) ----------------+
                    | (ç«‹å³å›åˆ° accept ç­‰å¾…ä¸‹ä¸€ä¸ªäºº)       |
                    |                                   |
                    |                                   +-> [Worker 1]
                    |                                   |   -> æŒæœ‰ shared_ptr (å¼•ç”¨è®¡æ•°=1)
                    |                                   |   -> read(fd=4)
                    |                                   |   -> ä¸šåŠ¡å¤„ç† (Echo / HTTP)
                    |                                   |   -> write(fd=4)
                    |                                   |   -> å‡½æ•°ç»“æŸï¼Œshared_ptr ææ„
                    |                                   |   -> Socket ææ„ -> close(fd=4)
```

### å…³é”®ç»„ä»¶äº¤äº’

1. **Main Thread**: ä»…è´Ÿè´£ `Accept`ï¼Œæé€Ÿå“åº”ï¼Œä¸è¿›è¡Œä»»ä½• I/O è¯»å†™ã€‚
2. **Socket Class**: è´Ÿè´£åº•å±‚çš„ API è°ƒç”¨å’Œèµ„æºæ¸…ç†ã€‚
3. **Shared Ptr**: å……å½“â€œç”Ÿå‘½å‘¨æœŸä¿å§†â€ã€‚å®ƒä¿è¯äº†å³ä½¿ä¸»çº¿ç¨‹çš„å¾ªç¯è¿›å…¥ä¸‹ä¸€è½®ï¼Œå·¥ä½œçº¿ç¨‹é‡Œçš„ Socket ä¾ç„¶å­˜æ´»ï¼Œç›´åˆ°ä»»åŠ¡å¤„ç†å®Œæ¯•ã€‚

------

## ğŸ“ å…³é”®ä»£ç è§£æ

### 1. `Socket.cpp` - é¿å‘æŒ‡å—

```c++
// ç§»åŠ¨æ„é€ å‡½æ•°ï¼šæ¥ç®¡èµ„æºï¼Œæ‰“æ–­åè·¯
Socket::Socket(Socket&& other) noexcept {
    fd_ = other.fd_;   // 1. å·èµ° fd
    other.fd_ = -1;    // 2. å…³é”®ï¼æŠŠåŸæ¥çš„ fd ç½®ä¸ºæ— æ•ˆï¼Œé˜²æ­¢å®ƒææ„æ—¶å…³é—­è¿æ¥
}

// ç»‘å®šåœ°å€
void Socket::BindAddress(int port) {
    struct sockaddr_in address;
    // ... é…ç½® address ç»“æ„ä½“ ...
    
    // reinterpret_cast: æš´åŠ›ç±»å‹è½¬æ¢
    // C è¯­è¨€çš„ bind å‡½æ•°è¦æ±‚ä¼ å…¥é€šç”¨çš„ sockaddr* æŒ‡é’ˆï¼Œ
    // ä½†æˆ‘ä»¬é…ç½®çš„æ˜¯ IPv4 ä¸“ç”¨çš„ sockaddr_inã€‚
    ::bind(fd_, reinterpret_cast<struct sockaddr*>(&address), sizeof(address));
}
```

### 2. `main.cpp` - å¹¶å‘ä¸ç”Ÿå‘½å‘¨æœŸ

```c++
// 1. æ¥å—è¿æ¥
Socket client = server.Accept(); // client æ˜¯ä¸ªå³å€¼ï¼Œé©¬ä¸Šè¦é”€æ¯

// 2. å°† Socket ç§»åŠ¨åˆ°å †ä¸Šçš„ shared_ptr ä¸­
// make_shared ä¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶å—ï¼Œå¼•ç”¨è®¡æ•°åˆå§‹åŒ–ä¸º 1
auto client_ptr = std::make_shared<Socket>(std::move(client));

// 3. æäº¤ç»™çº¿ç¨‹æ± 
// Lambda æ•è· client_ptr (å€¼ä¼ é€’ï¼Œå‘ç”Ÿæ‹·è´)
// æ­¤æ—¶å¼•ç”¨è®¡æ•° +1ï¼Œä¿è¯äº†åœ¨ Lambda æ‰§è¡ŒæœŸé—´ï¼ŒSocket ä¸ä¼šæ­»
pool.Submit([client_ptr]() {
    HandleClient(client_ptr);
});
```

------

## ğŸ› ï¸ æ„å»ºä¸è¿è¡Œ

### 1. ç¼–è¯‘

```bash
mkdir build
cd build
cmake ..
make
```

### 2. è¿è¡ŒæœåŠ¡å™¨

```bash
./server
# è¾“å‡ºï¼šServer listening on port 8080...
```

### 3. æµ‹è¯• (å®¢æˆ·ç«¯)

**ä½¿ç”¨ `nc` (Netcat) æµ‹è¯• TCP Echo** æ‰“å¼€æ–°ç»ˆç«¯ï¼š

```bash
nc localhost 8080
# è¾“å…¥: Hello
# è¿”å›: Server Echo: Hello
```

------

## ğŸ“‚ é¡¹ç›®ç»“æ„

```tex
Week05_Networking/
â”œâ”€â”€ CMakeLists.txt       # CMake æ„å»ºé…ç½®
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ Socket.hpp       # [æ ¸å¿ƒ] Socket RAII å°è£…ç±»çš„å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ThreadPool.hpp   # [å¤ç”¨] Week04 çš„çº¿ç¨‹æ± 
â”‚   â””â”€â”€ SafeQueue.hpp    # [å¤ç”¨] Week04 çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
â””â”€â”€ src/
    â”œâ”€â”€ Socket.cpp       # [æ ¸å¿ƒ] Socket å®ç° (éšè—åº•å±‚ C API ç»†èŠ‚)
    â””â”€â”€ main.cpp         # [å…¥å£] æœåŠ¡å™¨ä¸»å¾ªç¯ä¸ä¸šåŠ¡é€»è¾‘
```
